<!DOCTYPE html>
<html lang="en">
<%- include("../partials/head.ejs") %>

<body class="bg-gray-100 min-h-screen">
<%- include("../partials/toast.ejs") %>

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <%- include("./components/sidebar.ejs", { currentPath, author, pageTitle }) %>

  <!-- MAIN -->
  <div class="flex-1 flex flex-col">

    <!-- HEADER -->
    <header class="bg-white border-b px-6 py-4 flex justify-between items-center">
  <!-- LEFT -->
  <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-3">
    <span class="rounded-full bg-indigo-50 px-4 py-1 text-sm font-semibold text-indigo-700">
      <%= author.username.toUpperCase() %>
    </span>
    Notifications
  </h2>

  <!-- RIGHT -->
  <div class="flex items-center gap-5">

    <!-- ‚¨Ö Back Button -->
    <button
      onclick="window.history.back()"
      class="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 bg-gray-100 px-3 py-2 rounded-lg hover:bg-gray-200 transition"
    >
      <i class="fa-solid fa-arrow-left"></i>
      Back
    </button>

    <!-- üö™ Logout -->
    <form action="/authors/auth/logout" method="POST">
      <button
        type="submit"
        class="flex items-center gap-2 text-sm font-medium text-red-600 bg-red-50 px-3 py-2 rounded-lg hover:bg-red-100 transition"
      >
        <i class="fa-solid fa-right-from-bracket"></i>
        Logout
      </button>
    </form>

  </div>
</header>

    <!-- CONTENT -->
    <main class="flex-1 p-6 max-w-5xl mx-auto w-full">

      <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">

        <% if (notifications.length) { %>

          <% notifications.forEach(n => { %>
            <a
              href="<%= n.redirectUrl %>"
                        data-id="<%= n._id %>"
  data-read="<%= n.isRead %>"
              class="notification-item
                relative flex gap-4 px-6 py-5 border-b transition
                <%= n.isRead
                  ? 'hover:bg-gray-50'
                  : 'bg-indigo-50/60 hover:bg-indigo-50'
                %>
              "
            >

              <% if (!n.isRead) { %>
                <span class="absolute left-0 top-0 h-full w-1 bg-indigo-600"></span>
              <% } %>

              <div class="
                w-10 h-10 rounded-xl flex items-center justify-center shrink-0
                <%= n.isRead ? 'bg-gray-100 text-gray-500' : 'bg-indigo-600 text-white' %>
              ">
                <i class="fa-solid fa-bell"></i>
              </div>

              <div class="flex-1">
                <p class="<%= n.isRead ? 'text-gray-700' : 'font-medium text-gray-900' %>">
                  <%= n.message %>
                </p>
                <p class="text-xs text-gray-400 mt-1">
                  <%= new Date(n.createdAt).toLocaleString() %>
                </p>
              </div>

            </a>
          <% }) %>

        <% } else { %>

          <!-- EMPTY -->
          <div class="py-16 text-center text-gray-500">
            <i class="fa-regular fa-bell-slash text-3xl mb-2"></i>
            <p>No notifications found</p>
          </div>

        <% } %>

      </div>

      <!-- PAGINATION -->
      <% if (pagination.totalPages > 1) { %>
        <div class="flex justify-between items-center mt-6">

          <p class="text-sm text-gray-500">
            Page <%= pagination.page %> of <%= pagination.totalPages %>
          </p>

          <div class="flex gap-2">

            <% if (pagination.hasPrev) { %>
              <a href="?page=<%= pagination.page - 1 %>"
                 class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                ‚Üê Prev
              </a>
            <% } %>

            <% if (pagination.hasNext) { %>
              <a href="?page=<%= pagination.page + 1 %>"
                 class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                Next ‚Üí
              </a>
            <% } %>

          </div>
        </div>
      <% } %>

    </main>

    <%- include("./components/footer.ejs", { author }) %>
  </div>
</div>


<script>
  document.querySelectorAll('.notification-item').forEach(item => {
    item.addEventListener('click', async (e) => {
      const notificationId = item.dataset.id;
      const isRead = item.dataset.read === 'true';

      if (isRead) return; // already read, allow redirect

      e.preventDefault(); // stop navigation

      // üî• INSTANT UI UPDATE (optimistic)
      item.dataset.read = 'true';
      item.classList.remove('bg-indigo-50/60');
      item.classList.add('hover:bg-gray-50');

      item.querySelector('.w-1')?.remove(); // left bar
      item.querySelector('.w-2')?.remove(); // dot

      const text = item.querySelector('p');
      text?.classList.remove('font-medium');
      text?.classList.add('text-gray-700');

      // üîî Badge update
      const badge = document.getElementById('notification-badge');
      if (badge) {
        const count = Math.max(0, Number(badge.innerText) - 1);
        if (count === 0) badge.remove();
        else badge.innerText = count;
      }

      // üî• SERVER UPDATE
      try {
        await fetch(`/authors/notifications/${notificationId}/read`, {
          method: 'PATCH',
        });
      } catch (err) {
        console.error('Failed to update notification');
      }

      // üîÅ Redirect AFTER UI update
      window.location.href = item.dataset.url || '#';
    });
  });
</script>


</body>
</html>
