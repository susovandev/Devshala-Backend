<!-- ðŸ”” REALTIME NOTIFICATION CONTAINER -->
<div id="notification-container" class="fixed top-20 right-6 w-80 z-[9999] space-y-3"></div>

<!-- ðŸ”” REALTIME NOTIFICATION -->
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  socket.on('connect', () => {
    console.log('Connected to server');
  });

  const authorId = '<%= author._id %>';
  console.log('Author id', authorId);

  socket.emit('author:room', authorId);

  socket.on('notification:new', (data) => {
    // ===== TOAST =====
    const container = document.getElementById('notification-container');

    const toast = document.createElement('div');
    toast.className = 'relative bg-indigo-50 border border-indigo-200 p-3 rounded';

    toast.innerHTML = `
  <!-- CLOSE BUTTON -->
  <button
    class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 transition"
    aria-label="Close notification"
  >
    <i class="fa-solid fa-xmark text-sm"></i>
  </button>

  <p class="text-sm font-medium pr-6">${data.message}</p>
  <p class="text-xs text-gray-500">Just now</p>
`;

    // close handler (UI only)
    toast.querySelector('button').addEventListener('click', () => {
      toast.remove();
    });
    container.prepend(toast);

    // ===== BADGE =====
    let badge = document.getElementById('notification-badge');

    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'notification-badge';
      badge.className =
        'absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-medium';
      badge.innerText = '1';
      document.getElementById('notification-bell').appendChild(badge);
    } else {
      badge.innerText = Number(badge.innerText) + 1;
    }

    // ===== DROPDOWN LIST =====
    const list = document.getElementById('notification-list');

    if (list) {
      const item = document.createElement('a');
      item.href = '#';
      item.dataset.id = data._id;
      item.dataset.read = 'false';
      item.className =
        'notification-item relative flex gap-3 px-4 py-3 border-b text-sm bg-indigo-50/60 hover:bg-indigo-50 transition';

      item.innerHTML = `
      <span class="absolute left-0 top-0 h-full w-1 bg-indigo-500"></span>

      <div class="mt-1 text-indigo-600 shrink-0">
        <i class="fa-solid fa-circle-info"></i>
      </div>

      <div class="flex-1">
        <p class="text-gray-900 font-medium leading-relaxed">
          ${data.message}
        </p>
        <span class="text-xs text-gray-400">
          Just now
        </span>
      </div>

      <span class="mt-2 w-2 h-2 bg-indigo-500 rounded-full"></span>
    `;

      list.prepend(item);
    }

    // ===== STATS TEXT =====
    const stats = document.getElementById('notification-stats');
    if (stats) {
      const unread = Number(badge.innerText);
      const total = list?.children.length || unread;
      stats.innerText = `${unread} unread â€¢ ${total} total`;
    }
  });
</script>

<!-- ðŸ”” READ NOTIFICATION HANDLER -->
<script>
  document.querySelectorAll('.notification-item').forEach((item) => {
    item.addEventListener('click', (e) => {
      const isRead = item.dataset.read === 'true';
      const notificationId = item.dataset.id;

      if (!isRead) {
        e.preventDefault();

        // Fire & forget
        fetch(`/authors/notifications/${notificationId}/read`, {
          method: 'PATCH',
        }).catch(() => {});

        item.dataset.read = 'true';
        item.classList.remove('bg-indigo-50/60');
        item.classList.add('hover:bg-gray-50');
        item.querySelector('.w-1')?.remove();
        item.querySelector('.w-2')?.remove();

        const badge = document.getElementById('notification-badge');
        if (badge) {
          const count = Math.max(0, Number(badge.innerText) - 1);
          if (count === 0) badge.remove();
          else badge.innerText = count;
        }

        window.location.href = item.href;
      }
    });
  });
</script>
